<VirtualHost *:443>
    ServerName %%branch%%.%%domain%%
    ServerAdmin info@1vp.ru

    DocumentRoot /var/www/test

    <Proxy *>
        AuthType none
        AuthBasicAuthoritative Off
        SetEnv proxy-chain-auth On
        Order allow,deny
        Allow from all
    </Proxy>

    SetEnvIf X-Forwarded-For "^.*\..*\..*\..*" forwarded
    SetEnvIf X-Forwarded-Proto "^.*\..*\..*\..*" forwarded
    SetEnvIf X-Forwarded-Host "^.*\..*\..*\..*" forwarded
    SetEnvIf X-Forwarded-Port "^.*\..*\..*\..*" forwarded
    SetEnvIf X-Forwarded-Prefix "^.*\..*\..*\..*" forwarded

    ProxyRequests Off
    ProxyPreserveHost On
    # RequestHeader set X-Forwarded-Proto "https"

    ProxyPass /websocket ws://%%container_ip%%/websocket
    ProxyPassReverse /websocket ws://%%container_ip%%/websocket

    ProxyPass / http://%%container_ip%%/
    ProxyPassReverse / http://%%container_ip%%/
    <Directory /var/www/test>
        Order deny,allow
        Allow from all
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/%%branch%%.%%domain%%-error.log
    LogLevel debug
    CustomLog ${APACHE_LOG_DIR}/%%branch%%.%%domain%%.log combined

    SSLCertificateFile /etc/letsencrypt/live/%%domain%%/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/%%domain%%/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
